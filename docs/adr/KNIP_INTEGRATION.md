# Architecture Decision Record: Knip Integration for Dead Code Detection

## Status

Accepted

## Context

MCP Routerは複数のワークスペースを持つmonorepoプロジェクトです。コードベースが成長するにつれて、以下の課題が顕在化しています：

- 未使用のコード、依存関係、エクスポートの蓄積
- 不要な依存関係によるビルド時間の増加とバンドルサイズの肥大化
- メンテナンスコストの増加
- 新規開発者にとってのコードベースの理解の困難さ

これらの課題を解決するため、自動的にデッドコードを検出し、コードベースをクリーンに保つ仕組みが必要です。

## Decision

[Knip](https://knip.dev/)を採用し、monorepo全体でデッドコード検出を自動化します。

### 選定理由

1. **TypeScript/JavaScript特化**: TypeScriptプロジェクトに最適化されており、型情報を活用した正確な分析が可能
2. **Monorepoサポート**: ワークスペース単位での分析と設定が可能
3. **包括的な検出**: ファイル、依存関係、エクスポートの未使用を一元的に検出
4. **CI/CD統合**: 自動化パイプラインへの組み込みが容易
5. **Turbo対応**: キャッシュを活用した高速な分析が可能

## Consequences

### Positive

1. **コード品質の向上**
   - 未使用コードの自動検出により、コードベースがクリーンに保たれる
   - 定期的な分析により、技術的負債の蓄積を防げる

2. **ビルドパフォーマンスの改善**
   - 不要な依存関係の削除によりビルド時間が短縮
   - バンドルサイズの削減による配布物のサイズ最適化

3. **開発者体験の向上**
   - コードベースの可読性向上
   - 新規開発者のオンボーディングが容易に

4. **自動化によるコスト削減**
   - 手動でのデッドコード検出作業が不要
   - CI/CDパイプラインでの自動チェック

### Negative

1. **初期設定の複雑さ**
   - 各ワークスペースごとの設定が必要
   - False positiveへの対応（ignore設定の調整）

2. **ビルドパイプラインへの負荷**
   - 分析処理による追加の実行時間
   - （Turboキャッシュにより軽減可能）
## Implementation

### アーキテクチャ

```
┌─────────────────────────────────────────────────┐
│                  Turbo Pipeline                  │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐         │
│  │  Build  │→ │  Knip   │→ │  Test   │         │
│  └─────────┘  └─────────┘  └─────────┘         │
└─────────────────────────────────────────────────┘
       ↓              ↓              ↓
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ Workspace 1 │ │ Workspace 2 │ │ Workspace N │
│   (apps/)   │ │ (packages/) │ │    (...)    │
└─────────────┘ └─────────────┘ └─────────────┘
```

### デバッグとトラブルシューティング

```bash
# デバッグ情報付きで実行
pnpm knip --debug

# 設定のヒントを表示
pnpm knip --include-config-hints

# ドライラン
pnpm turbo knip --dry-run
```

### パフォーマンス最適化

1. **Turboキャッシュの活用**: 常に`pnpm turbo knip`で実行
2. **ワークスペースフィルタリング**: `--filter`で特定ワークスペースのみ分析
3. **並列実行**: Turboによる複数ワークスペースの並列分析
4. **インプット設定**: 変更検出用のファイルパターンを最適化

### 運用ガイドライン

1. **定期実行**
   - 開発中: `pnpm knip`で随時チェック
   - PR時: CIで自動チェック
   - 週次: 全体スキャンとレポート生成

2. **False Positive対応**
   - 必要に応じて`knip.json`のignoreパターンを更新
   - ワークスペース固有の設定を活用

3. **段階的改善**
   - 既存のデッドコードは段階的に削除
   - 新規コードではゼロトレランス

## Alternatives Considered

1. **ESLint no-unused-vars**
   - 制限: ファイルレベルの未使用検出ができない
   - 制限: 依存関係の分析ができない

2. **ts-prune**
   - 制限: TypeScriptのエクスポートのみ対象
   - 制限: Monorepoサポートが限定的

3. **手動チェック**
   - 問題: スケーラブルでない
   - 問題: 人的エラーのリスク

## References

- [Knip Documentation](https://knip.dev/)
- [Turbo Documentation](https://turbo.build/)